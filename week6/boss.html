<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Week 6 – Final Boss (Abbreviations)</title>

  <!-- Kitimus preload (prevents flicker) -->
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-neutral.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-squint.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-celebrate.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-blink.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-squint-left.png">
  <link rel="preload" as="image" href="/mascots/kitimus/kitimus-squint-right.png">

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --shadow:0 10px 30px rgba(15,23,42,.12);
      --radius:18px;
      --link:#1d4ed8;

      --btn:#0f172a;
      --btn2:#e5e7eb;
      --btn2text:#111827;

      --bar:#c7d2fe;
      --barbg:#e5e7eb;

      --good:#22c55e;
      --bad:#ef4444;

      --h1: clamp(26px, 5.6vw, 44px);
      --h2: clamp(14px, 3.8vw, 18px);
      --pill: clamp(12px, 3.2vw, 14px);

      --pad: 12px;
      --gap: 10px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:auto;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      padding:10px 14px;
      background:#fff;
      box-shadow:0 1px 10px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      gap:10px;
    }
    header a{
      text-decoration:none;
      color:var(--link);
      font-weight:900;
      white-space:nowrap;
    }
    header h1{
      margin:0;
      font-size:16px;
      font-weight:1000;
      text-align:center;
      flex:1;
    }
    header .spacer{ width:52px; }

    main{
      padding:12px;
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:100%;
      max-width:720px;
    }

    .toprow{
      position:relative;
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .pill{
      background:#dbeafe;
      color:#1e3a8a;
      font-weight:1000;
      border-radius:999px;
      padding:8px 12px;
      font-size:var(--pill);
      min-width:110px;
      text-align:center;
      white-space:nowrap;
    }
    .barwrap{
      flex:1;
      height:18px;
      background:var(--barbg);
      border-radius:999px;
      position:relative;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .bar{
      height:100%;
      width:0%;
      background:var(--bar);
      border-radius:999px;
      transition:width .25s ease;
    }
    .bartext{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:#111827;
      font-size:14px;
      text-shadow:0 1px 0 rgba(255,255,255,.75);
      pointer-events:none;
    }

    .kitimus{
      justify-self:end;
      align-self:center;
      width: clamp(52px, 10vw, 76px);
      height: clamp(52px, 10vw, 76px);
      pointer-events:none;
      user-select:none;
    }
    .kitimus img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    .heartsRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 0 0 10px 0;
    }
    .heartsLeft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .heartsPill{
      background:#eef2ff;
      color:#28327a;
      font-weight:1000;
      border-radius:999px;
      padding:6px 10px;
      font-size:13px;
      white-space:nowrap;
    }
    .hearts{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:20px;
      line-height:1;
      user-select:none;
    }
    .scoreMini{
      color:var(--muted);
      font-weight:1000;
      font-size:13px;
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      overflow:hidden;
    }

    .imgbox{
      border-radius:16px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
      height:220px;
      overflow:hidden;
    }
    .imgbox img{
      width:100%;
      height:100%;
      object-fit:contain;
      border-radius:12px;
    }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .qtitle{
      font-size:var(--h1);
      font-weight:1000;
      line-height:1.05;
      margin-top:2px;
    }
    .mark{
      visibility:hidden;
      font-weight:1000;
      line-height:1;
      font-size: clamp(34px, 9vw, 70px);
      min-width: 44px;
      text-align:right;
      user-select:none;
    }
    .mark.good{ color: var(--good); }
    .mark.bad{  color: var(--bad);  }

    .qsub{
      color:var(--muted);
      font-weight:800;
      margin-bottom:2px;
      font-size:var(--h2);
    }

    .inputWrap{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      margin-top:6px;
    }
    .abbrInput{
      width: 160px;
      max-width: 60vw;
      text-align:center;
      font-weight:1000;
      letter-spacing:6px;
      font-size: 28px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 2px solid #e5e7eb;
      outline: none;
      background:#fff;
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
    }
    .abbrInput.ok{
      border-color: var(--good);
      background:#ecfdf5;
    }
    .abbrInput.bad{
      border-color: var(--bad);
      background:#fef2f2;
    }

    .review{
      margin-top:6px;
      padding:12px;
      border-radius:16px;
      background:#f8fafc;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
    }
    .review h2{
      margin:0 0 6px 0;
      font-size:16px;
      font-weight:1000;
    }
    .review ul{
      margin:0;
      padding-left:18px;
      color:#111827;
      font-weight:800;
    }
    .small{
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      margin-top:8px;
      line-height:1.35;
    }

    @media (max-height: 700px){
      :root{ --pad: 10px; --gap: 8px; }
      .imgbox{ height:190px; }
      .abbrInput{ font-size:26px; padding:12px 14px; }
    }
    @media (max-height: 620px){
      .imgbox{ height:160px; }
    }
  </style>
</head>

<body>
  <header>
    <a href="./index.html">← Back</a>
    <h1>Final Boss</h1>
    <div class="spacer"></div>
  </header>

  <main>
    <div class="wrap">
      <div class="toprow">
        <div class="pill" id="sectionPill">Boss</div>
        <div class="barwrap" aria-label="Progress">
          <div class="bar" id="bar"></div>
          <div class="bartext" id="barText">1 of 29</div>
        </div>
        <div class="kitimus" aria-hidden="true">
          <img id="kitimusImg" src="/mascots/kitimus/kitimus-neutral.png" alt="">
        </div>
      </div>

      <div class="heartsRow">
        <div class="heartsLeft">
          <div class="heartsPill">Hearts</div>
          <div class="hearts" id="hearts"></div>
        </div>
        <div class="scoreMini" id="scoreMini">Score: 0</div>
      </div>

      <section class="card" id="card">
        <div class="imgbox" id="imgbox"><img id="img" alt="" /></div>

        <div class="titleRow">
          <div class="qtitle" id="qtitle">Type the abbreviation</div>
          <div class="mark" id="mark" aria-hidden="true"></div>
        </div>

        <div class="qsub" id="qsub">Two letters. No hints. No healing.</div>

        <div class="inputWrap">
          <input
            id="abbr"
            class="abbrInput"
            type="text"
            inputmode="text"
            maxlength="2"
            autocomplete="off"
            autocapitalize="characters"
            spellcheck="false"
            aria-label="Type the two-letter abbreviation"
          />
        </div>

        <div id="reviewBox" style="display:none;"></div>
      </section>
    </div>
  </main>

  <script>
    // =========================
    // FINAL BOSS: Abbreviations
    // Auto-check on 2nd letter
    // No healing. End at 0 hearts.
    // =========================

    const STATES = [
      // Week 1
      { state:"Maine",         abbrev:"ME", key:"me", img:"../week1/images/me.png" },
      { state:"New Hampshire", abbrev:"NH", key:"nh", img:"../week1/images/nh.png" },
      { state:"Vermont",       abbrev:"VT", key:"vt", img:"../week1/images/vt.png" },
      { state:"Massachusetts", abbrev:"MA", key:"ma", img:"../week1/images/ma.png" },
      { state:"Connecticut",   abbrev:"CT", key:"ct", img:"../week1/images/ct.png" },
      { state:"Rhode Island",  abbrev:"RI", key:"ri", img:"../week1/images/ri.png" },

      // Week 2
      { state:"New York",      abbrev:"NY", key:"ny", img:"../week2/images/ny.png" },
      { state:"Pennsylvania",  abbrev:"PA", key:"pa", img:"../week2/images/pa.png" },
      { state:"New Jersey",    abbrev:"NJ", key:"nj", img:"../week2/images/nj.png" },
      { state:"Delaware",      abbrev:"DE", key:"de", img:"../week2/images/de.png" },

      // Week 3
      { state:"Maryland",      abbrev:"MD", key:"md", img:"../week3/images/md.png" },
      { state:"Virginia",      abbrev:"VA", key:"va", img:"../week3/images/va.png" },
      { state:"West Virginia", abbrev:"WV", key:"wv", img:"../week3/images/wv.png" },
      { state:"North Carolina",abbrev:"NC", key:"nc", img:"../week3/images/nc.png" },
      { state:"South Carolina",abbrev:"SC", key:"sc", img:"../week3/images/sc.png" },

      // Week 4
      { state:"Michigan",      abbrev:"MI", key:"mi", img:"../week4/images/mi.png" },
      { state:"Indiana",       abbrev:"IN", key:"in", img:"../week4/images/in.png" },
      { state:"Ohio",          abbrev:"OH", key:"oh", img:"../week4/images/oh.png" },
      { state:"Kentucky",      abbrev:"KY", key:"ky", img:"../week4/images/ky.png" },
      { state:"Tennessee",     abbrev:"TN", key:"tn", img:"../week4/images/tn.png" },

      // Week 5
      { state:"Mississippi",   abbrev:"MS", key:"ms", img:"../week5/images/ms.png" },
      { state:"Alabama",       abbrev:"AL", key:"al", img:"../week5/images/al.png" },
      { state:"Georgia",       abbrev:"GA", key:"ga", img:"../week5/images/ga.png" },
      { state:"Florida",       abbrev:"FL", key:"fl", img:"../week5/images/fl.png" },

      // Week 6
      { state:"Minnesota",     abbrev:"MN", key:"mn", img:"./images/mn.png" },
      { state:"Wisconsin",     abbrev:"WI", key:"wi", img:"./images/wi.png" },
      { state:"Iowa",          abbrev:"IA", key:"ia", img:"./images/ia.png" },
      { state:"Illinois",      abbrev:"IL", key:"il", img:"./images/il.png" },
      { state:"Missouri",      abbrev:"MO", key:"mo", img:"./images/mo.png" }
    ];

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // Optional: randomize boss order (comment out if you want fixed order)
    const QUESTIONS = shuffle(STATES);

    const total = QUESTIONS.length;

    // Hearts rule: max(3, round(total * 0.10))
    const START_HEARTS = Math.max(3, Math.round(total * 0.10));

    // ====== UI hooks ======
    const sectionPill = document.getElementById("sectionPill");
    const bar = document.getElementById("bar");
    const barText = document.getElementById("barText");
    const heartsEl = document.getElementById("hearts");
    const scoreMini = document.getElementById("scoreMini");

    const img = document.getElementById("img");
    const qtitle = document.getElementById("qtitle");
    const qsub = document.getElementById("qsub");
    const markEl = document.getElementById("mark");
    const abbrInput = document.getElementById("abbr");
    const reviewBox = document.getElementById("reviewBox");

    // ===== Kitimus =====
    const kitimusImg = document.getElementById("kitimusImg");
    const KITIMUS = {
      neutral: "/mascots/kitimus/kitimus-neutral.png",
      squint: "/mascots/kitimus/kitimus-squint.png",
      squintLeft: "/mascots/kitimus/kitimus-squint-left.png",
      squintRight: "/mascots/kitimus/kitimus-squint-right.png",
      blink: "/mascots/kitimus/kitimus-blink.png",
      celebrate: "/mascots/kitimus/kitimus-celebrate.png"
    };

    function setKitimus(state){
      if(!kitimusImg) return;
      const src = KITIMUS[state] || KITIMUS.neutral;
      if(kitimusImg.getAttribute("src") !== src){
        kitimusImg.setAttribute("src", src);
      }
    }

    let kitimusIdleTimer = null;
    function stopKitimusIdle(){
      if(kitimusIdleTimer){
        clearInterval(kitimusIdleTimer);
        kitimusIdleTimer = null;
      }
    }
    function startKitimusIdle(){
      stopKitimusIdle();
      setKitimus("squint");

      kitimusIdleTimer = setInterval(() => {
        if(locked) return;

        const r = Math.random();

        if(r < 0.22){
          setKitimus("blink");
          setTimeout(() => setKitimus("squint"), 140);
          return;
        }

        if(r < 0.55){
          const dir = (Math.random() < 0.5) ? "squintLeft" : "squintRight";
          setKitimus(dir);
          setTimeout(() => setKitimus("squint"), 220);
          return;
        }

        setKitimus("squint");
      }, 2200);
    }

    function kitimusWrongPulse(){
      setTimeout(() => setKitimus("neutral"), 120);
      setTimeout(() => setKitimus("squint"), 650);
    }

    // ===== State =====
    let idx = 0;
    let locked = false;
    let score = 0;
    let hearts = START_HEARTS;
    const missed = new Set();

    function renderHearts(){
      // full hearts only (no healing, so no empty-heart tracking needed)
      heartsEl.innerHTML = "";
      for(let i=0;i<hearts;i++){
        const s = document.createElement("span");
        s.textContent = "❤️";
        heartsEl.appendChild(s);
      }
      // if hearts is 0, show nothing (clean)
      if(hearts === 0){
        heartsEl.textContent = "";
      }
    }

    function resetMark(){
      markEl.textContent = "";
      markEl.classList.remove("good","bad");
      markEl.style.visibility = "hidden";
    }
    function showMark(ok){
      markEl.style.visibility = "visible";
      markEl.textContent = ok ? "✓" : "✕";
      markEl.classList.toggle("good", ok);
      markEl.classList.toggle("bad", !ok);
    }

    function setProgress(){
      const pos = idx + 1;
      const pct = Math.round((pos / total) * 100);
      bar.style.width = pct + "%";
      barText.textContent = `${pos} of ${total}`;
      sectionPill.textContent = "Boss";
      scoreMini.textContent = `Score: ${score}`;
    }

    function sanitizeToLetters2(v){
      return v.toUpperCase().replace(/[^A-Z]/g, "").slice(0,2);
    }

    function renderQuestion(){
      locked = false;
      resetMark();

      abbrInput.classList.remove("ok","bad");
      abbrInput.value = "";
      abbrInput.disabled = false;

      const q = QUESTIONS[idx];

      img.src = q.img;
      img.alt = `${q.state} highlighted`;

      qtitle.textContent = "Type the abbreviation";
      qsub.textContent = `State: ${q.state}`;

      setKitimus("squint");
      startKitimusIdle();
      setProgress();
      renderHearts();

      // focus input every question
      setTimeout(() => abbrInput.focus(), 50);
    }

    function gradeAttempt(attempt){
      if(locked) return;
      locked = true;

      const q = QUESTIONS[idx];
      const ok = (attempt === q.abbrev);

      stopKitimusIdle();

      showMark(ok);
      abbrInput.classList.add(ok ? "ok" : "bad");
      abbrInput.disabled = true;

      if(ok){
        score += 1;
        setKitimus("squint");
      } else {
        hearts -= 1; // NO HEALING
        missed.add(`Abbreviations: ${q.state}`);
        kitimusWrongPulse();
        renderHearts();
      }

      scoreMini.textContent = `Score: ${score}`;

      // If hearts hit 0: immediate game over (hard stop)
      if(!ok && hearts <= 0){
        setTimeout(() => showSummary(true), 500);
        return;
      }

      // Otherwise, advance after a short beat
      setTimeout(() => {
        if(idx >= total - 1){
          showSummary(false);
        } else {
          idx += 1;
          renderQuestion();
        }
      }, 350);
    }

    function showSummary(gameOver){
      stopKitimusIdle();

      // lock input
      locked = true;
      abbrInput.disabled = true;

      // full progress bar
      bar.style.width = "100%";
      barText.textContent = `${idx + 1} of ${total}`;
      scoreMini.textContent = `Score: ${score}`;

      // headline
      const pct = total ? Math.round((score / total) * 100) : 0;

      if(gameOver){
        qtitle.textContent = `Game Over`;
        qsub.textContent = `You ran out of hearts. Final score: ${score} of ${total} (${pct}%).`;
        showMark(false);
        setKitimus("neutral");
      } else {
        qtitle.textContent = `Boss Complete: ${pct}%`;
        qsub.textContent = `You got ${score} out of ${total} correct.`;
        showMark(pct >= 80);
        if(pct === 100) setTimeout(() => setKitimus("celebrate"), 200);
        else if(pct >= 80) setKitimus("squint");
        else setKitimus("neutral");
      }

      // show review list
      const misses = Array.from(missed);
      const tip = gameOver
        ? "Tip: Review the missed ones, then try again. Boss mode ends the moment hearts hit zero."
        : (pct === 100
            ? "Perfect run. Do a quick study pass later to lock it in."
            : "Tip: Study the ones you missed, then try again to beat your score.");

      reviewBox.style.display = "block";
      reviewBox.innerHTML = `
        <div class="review">
          <h2>${misses.length ? "Review these:" : "Nothing to review — nice work!"}</h2>
          ${misses.length ? `<ul>${misses.map(m => `<li>${m}</li>`).join("")}</ul>` : ""}
          <div class="small">${tip}</div>
        </div>
      `;
    }

    // Auto-check on 2nd character
    abbrInput.addEventListener("input", () => {
      if(locked) return;
      const clean = sanitizeToLetters2(abbrInput.value);
      if(abbrInput.value !== clean) abbrInput.value = clean;

      if(clean.length === 2){
        gradeAttempt(clean);
      }
    });

    // keep Kitimus responsive like your other pages
    document.addEventListener("pointerdown", () => {
      if(locked) return;
      setKitimus("blink");
      setTimeout(() => setKitimus("squint"), 120);
    }, { passive:true });

    // init
    renderHearts();
    renderQuestion();
  </script>
</body>
</html>
